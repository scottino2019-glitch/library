<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carina â€“ Libreria Digitale</title>
  <style>
    :root { 
      --primary:#6d4c41; 
      --primary-dark:#40241a; 
      --shadow:0 4px 8px rgba(0,0,0,.15); 
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif}
    body{background:#fafafa;color:#333}
    header{background:var(--primary);color:#fff;padding:1rem;text-align:center;font-weight:bold}
    main{max-width:1200px;margin:auto;padding:1rem}
    .hidden{display:none}
    .btn{background:var(--primary);color:#fff;padding:.45rem .9rem;border:none;border-radius:6px;cursor:pointer;margin:.2rem;box-shadow:var(--shadow)}
    .btn:hover{background:var(--primary-dark)}
    .btn-danger{background:#c62828}
    input{padding:.6rem;border:1px solid #ccc;border-radius:6px;width:100%}
    form{display:flex;flex-direction:column;gap:.75rem;background:#fff;padding:1rem;border-radius:10px;box-shadow:var(--shadow);max-width:400px;margin:auto}
    .books-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1rem;margin-top:1rem}
    .book-card{background:#fff;border-radius:10px;box-shadow:var(--shadow);padding:.5rem;display:flex;flex-direction:column;gap:.5rem;position:relative}
    .cover{width:100%;aspect-ratio:3/4;background:#eee;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .cover img{width:100%;height:100%;object-fit:cover}
    .badge{position:absolute;top:.5rem;left:.5rem;background:rgba(0,0,0,.6);color:#fff;padding:.2rem .4rem;border-radius:4px;font-size:.75rem}
    .title{font-weight:bold}
    .author{font-size:.9rem;opacity:.8}
    .actions{display:flex;gap:.3rem;flex-wrap:wrap}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);justify-content:center;align-items:center;z-index:1000}
    .reader{display:none;position:fixed;inset:0;background:#fff;z-index:1001;flex-direction:column}
    .reader-header{background:var(--primary);color:#fff;padding:.8rem;display:flex;justify-content:space-between;align-items:center}
    .reader-content{flex:1;overflow:auto;padding:1rem;position:relative}
    .reader-controls{display:flex;justify-content:center;align-items:center;gap:1rem;padding:0.5rem;background:#f5f5f5;border-bottom:1px solid #ddd}
    #pdfViewer{width:100%;overflow:auto;display:flex;flex-direction:column;align-items:center}
    #pdfViewer canvas{display:block;margin:1rem auto;box-shadow:var(--shadow);max-width:100%}
    #epubViewer{width:100%;height:100%;overflow:auto;background:#f9f9f9;padding:20px;box-sizing:border-box}
    #epubContent{max-width:800px;margin:0 auto;background:white;padding:2rem;box-shadow:var(--shadow);min-height:100%}
    .page-navigation{display:flex;align-items:center;gap:0.5rem}
    .epub-controls{display:flex;justify-content:center;gap:0.5rem;margin-top:1rem}
  </style>
</head>
<body>
<header>ðŸ“š Carina â€“ Libreria personale</header>
<main id="authView">
  <h2 style="text-align:center">Accedi o Registrati</h2>
  <form id="authForm">
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit" class="btn">Login / Registrazione</button>
    <div id="authMsg" style="color:#b3261e;text-align:center"></div>
  </form>
</main>
<main id="appView" class="hidden">
  <div style="display:flex;justify-content:space-between;align-items:center;margin:1rem 0">
    <h2>La tua libreria</h2>
    <div>
      <button id="uploadBtn" class="btn">Carica libro</button>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>
  </div>
  <div id="booksGrid" class="books-grid"></div>
</main>
<div id="uploadModal" class="modal">
  <form id="uploadForm">
    <h3>Nuovo libro</h3>
    <input type="text" id="bookTitle" placeholder="Titolo" required>
    <input type="text" id="bookAuthor" placeholder="Autore" required>
    <input type="file" id="bookFile" accept=".pdf,.epub" required>
    <div style="display:flex;justify-content:flex-end;gap:.5rem">
      <button type="button" id="cancelUpload" class="btn">Annulla</button>
      <button type="submit" class="btn">Carica</button>
    </div>
  </form>
</div>
<div class="reader" id="reader">
  <div class="reader-header">
    <div id="readerTitle">Titolo</div>
    <button class="btn" id="closeReader">Chiudi</button>
  </div>
  <div class="reader-controls" id="pdfControls" hidden>
    <button class="btn" id="prevPage">Precedente</button>
    <div class="page-navigation">
      <span>Pagina: </span>
      <span id="pageNum">0</span>
      <span> di </span>
      <span id="pageCount">0</span>
    </div>
    <button class="btn" id="nextPage">Successiva</button>
  </div>
  <div class="reader-content">
    <div id="pdfViewer" hidden></div>
    <div id="epubViewer" hidden>
      <div id="epubContent"></div>
      <div class="epub-controls">
        <button class="btn" id="prevChapter">Capitolo Precedente</button>
        <button class="btn" id="nextChapter">Capitolo Successivo</button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<!-- Versione corretta di PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>
<!-- Versione piÃ¹ recente di EPUB.js -->
<script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>
<script>
// Configurazione PDF.js
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

const SUPABASE_URL="https://zflxzjapcclnscbziwlt.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmbHh6amFwY2NsbnNjYnppd2x0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5ODIwMzEsImV4cCI6MjA3MTU1ODAzMX0.8W3FI_fsZtA0EH0TnHJwRbLbvaU476mLAW0DVw7mItI";
const BUCKET="library";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const authView=document.getElementById('authView');
const appView=document.getElementById('appView');
const booksGrid=document.getElementById('booksGrid');
const authMsg=document.getElementById('authMsg');

// Variabili per la gestione della visualizzazione PDF
let currentPdf = null;
let currentPage = 1;
let pdfRendering = false;
let pdfPageNumPending = null;
let pdfTotalPages = 0;

// Variabili per la gestione della visualizzazione EPUB
let currentBook = null;
let rendition = null;

function showAuth(){authView.classList.remove('hidden');appView.classList.add('hidden');}
function showApp(){authView.classList.add('hidden');appView.classList.remove('hidden');}

supabase.auth.onAuthStateChange((e)=>{if(e==='SIGNED_IN'){showApp();loadBooks();}if(e==='SIGNED_OUT'){showAuth();}});
window.addEventListener('DOMContentLoaded',async()=>{
 const {data}=await supabase.auth.getSession();
 if(data.session){showApp();loadBooks();}else{showAuth();}
});

document.getElementById('authForm').addEventListener('submit',async e=>{
e.preventDefault();authMsg.textContent='';
const email=document.getElementById('email').value.trim();
const password=document.getElementById('password').value;
let {error}=await supabase.auth.signInWithPassword({email,password});
if(error){
 const {error:err}=await supabase.auth.signUp({email,password,options:{emailRedirectTo:location.origin}});
 if(err){authMsg.textContent=err.message;return;}
 authMsg.textContent='Registrazione riuscita. Controlla la tua email per confermare.';
}
});

async function loadBooks(){
 const {data:{user}}=await supabase.auth.getUser();
 if(!user)return;
 const {data,error}=await supabase.from('books').select('*').eq('user_id',user.id).order('created_at',{ascending:false});
 if(error){alert(error.message);return;}
 booksGrid.innerHTML='';
 data.forEach(renderBookCard);
}

function renderBookCard(b){
 const card=document.createElement('div');card.className='book-card';
 const coverWrap=document.createElement('div');coverWrap.className='cover';
 const img=document.createElement('img');img.alt=b.title;coverWrap.appendChild(img);card.appendChild(coverWrap);
 const badge=document.createElement('div');badge.className='badge';badge.textContent=b.format.toUpperCase();card.appendChild(badge);
 const t=document.createElement('div');t.className='title';t.textContent=b.title;card.appendChild(t);
 const a=document.createElement('div');a.className='author';a.textContent=b.author;card.appendChild(a);
 const actions=document.createElement('div');actions.className='actions';
 const openBtn=document.createElement('button');openBtn.className='btn';openBtn.textContent='Apri';openBtn.onclick=()=>openBook(b);
 const delBtn=document.createElement('button');delBtn.className='btn btn-danger';delBtn.textContent='Elimina';delBtn.onclick=()=>deleteBook(b);
 actions.appendChild(openBtn);actions.appendChild(delBtn);card.appendChild(actions);
 booksGrid.appendChild(card);
 generateCover(b).then(url=>{if(url)img.src=url;}).catch(()=>{});
}

async function generateCover(book){
 const {data:s}=await supabase.storage.from(BUCKET).createSignedUrl(book.storage_path,3600,{download:false});
 if(!s?.signedUrl)return placeholderCover(book.format);
 const url=s.signedUrl;
 if(book.format==='pdf'){
   try {
     const pdf = await pdfjsLib.getDocument(url).promise;
     const page = await pdf.getPage(1);
     const viewport = page.getViewport({scale:0.3});
     const canvas = document.createElement('canvas');
     canvas.width = viewport.width;
     canvas.height = viewport.height;
     await page.render({canvasContext:canvas.getContext('2d'),viewport}).promise;
     return canvas.toDataURL('image/png');
   } catch (error) {
     console.error("Errore generazione copertina PDF:", error);
     return placeholderCover(book.format);
   }
 }
 return placeholderCover(book.format);
}

function placeholderCover(text){
 const c=document.createElement('canvas');c.width=300;c.height=400;const ctx=c.getContext('2d');
 ctx.fillStyle='#ccc';ctx.fillRect(0,0,300,400);
 ctx.fillStyle='#333';ctx.font='bold 32px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
 ctx.fillText(text.toUpperCase(),150,200);
 return c.toDataURL('image/png');
}

document.getElementById('uploadBtn').onclick=()=>{document.getElementById('uploadModal').style.display='flex';};
document.getElementById('cancelUpload').onclick=()=>{document.getElementById('uploadModal').style.display='none';};
document.getElementById('uploadForm').addEventListener('submit',async e=>{
e.preventDefault();
const title=document.getElementById('bookTitle').value.trim();
const author=document.getElementById('bookAuthor').value.trim();
const file=document.getElementById('bookFile').files[0];
const format=file.name.split('.').pop().toLowerCase();
const {data:{user}}=await supabase.auth.getUser();
const path=`${user.id}/${Date.now()}_${file.name}`;
await supabase.storage.from(BUCKET).upload(path,file);
await supabase.from('books').insert([{title,author,format,storage_path:path,user_id:user.id}]);
document.getElementById('uploadModal').style.display='none';document.getElementById('uploadForm').reset();loadBooks();
});

async function deleteBook(book){
 if(!confirm('Sei sicuro di voler eliminare questo libro?')) return;
 await supabase.storage.from(BUCKET).remove([book.storage_path]);
 await supabase.from('books').delete().eq('id',book.id);
 loadBooks();
}

// Funzioni per la navigazione del PDF
function renderPage(pageNum) {
  pdfRendering = true;
  
  currentPdf.getPage(pageNum).then(function(page) {
    const viewport = page.getViewport({scale: 1.2});
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    const renderContext = {
      canvasContext: ctx,
      viewport: viewport
    };
    
    const renderTask = page.render(renderContext);
    
    renderTask.promise.then(function() {
      pdfRendering = false;
      
      const pdfViewer = document.getElementById('pdfViewer');
      pdfViewer.innerHTML = '';
      pdfViewer.appendChild(canvas);
      
      document.getElementById('pageNum').textContent = pageNum;
      
      if (pdfPageNumPending !== null) {
        renderPage(pdfPageNumPending);
        pdfPageNumPending = null;
      }
    });
  });
}

function queueRenderPage(num) {
  if (pdfRendering) {
    pdfPageNumPending = num;
  } else {
    renderPage(num);
  }
}

function onPrevPage() {
  if (currentPage <= 1) {
    return;
  }
  currentPage--;
  queueRenderPage(currentPage);
}

function onNextPage() {
  if (currentPage >= pdfTotalPages) {
    return;
  }
  currentPage++;
  queueRenderPage(currentPage);
}

// Funzioni per la navigazione dell'EPUB
function prevChapter() {
  if (rendition) {
    rendition.prev();
  }
}

function nextChapter() {
  if (rendition) {
    rendition.next();
  }
}

// Aggiungi event listeners per la navigazione
document.getElementById('prevPage').addEventListener('click', onPrevPage);
document.getElementById('nextPage').addEventListener('click', onNextPage);
document.getElementById('prevChapter').addEventListener('click', prevChapter);
document.getElementById('nextChapter').addEventListener('click', nextChapter);

async function openBook(book){
 document.getElementById('readerTitle').textContent = book.title;
 const {data:s} = await supabase.storage.from(BUCKET).createSignedUrl(book.storage_path,3600,{download:false});
 if(!s?.signedUrl){alert('Impossibile aprire libro');return;}
 const url = s.signedUrl;
 document.getElementById('reader').style.display = 'flex';
 
 if(book.format === 'pdf'){
   document.getElementById('pdfViewer').hidden = false;
   document.getElementById('epubViewer').hidden = true;
   document.getElementById('pdfControls').hidden = false;
   
   try {
     currentPdf = await pdfjsLib.getDocument(url).promise;
     pdfTotalPages = currentPdf.numPages;
     document.getElementById('pageCount').textContent = pdfTotalPages;
     currentPage = 1;
     renderPage(currentPage);
   } catch (error) {
     console.error("Errore caricamento PDF:", error);
     alert("Errore nel caricamento del PDF");
   }
 } else {
   document.getElementById('pdfViewer').hidden = true;
   document.getElementById('epubViewer').hidden = false;
   document.getElementById('pdfControls').hidden = true;
   document.getElementById('epubContent').innerHTML = '<div style="text-align:center;padding:2rem;">Caricamento in corso...</div>';
   
   try {
     // Pulisci eventuali libri precedenti
     if (currentBook) {
       currentBook.destroy();
     }
     
     // Crea un nuovo libro EPUB
     currentBook = ePub(url);
     
     // Quando il libro Ã¨ pronto, crea il rendering
     currentBook.ready.then(function() {
       rendition = currentBook.renderTo("epubContent", {
         width: "100%",
         height: 600,
         spread: "auto"
       });
       
       rendition.display();
       
       // Aggiungi stili aggiuntivi per una migliore visualizzazione
       rendition.hooks.content.register(function(contents) {
         contents.addStylesheet('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
         contents.addStylesheet(`
           body {
             font-family: 'Roboto', sans-serif;
             line-height: 1.6;
             color: #333;
             padding: 1rem;
           }
           p {
             margin-bottom: 1rem;
           }
         `);
       });
     });
     
   } catch (error) {
     console.error("Errore caricamento EPUB:", error);
     document.getElementById('epubContent').innerHTML = `
       <div style="text-align:center;padding:2rem;">
         <h3>Errore nel caricamento del libro</h3>
         <p>Impossibile visualizzare questo formato EPUB.</p>
         <p>${error.message}</p>
       </div>
     `;
   }
 }
}

document.getElementById('closeReader').onclick = () => {
  document.getElementById('reader').style.display = 'none';
  document.getElementById('pdfViewer').innerHTML = '';
  document.getElementById('epubContent').innerHTML = '';
  
  // Reset delle variabili PDF
  currentPdf = null;
  currentPage = 1;
  pdfRendering = false;
  pdfPageNumPending = null;
  pdfTotalPages = 0;
  
  // Reset delle variabili EPUB
  if (rendition) {
    rendition.destroy();
    rendition = null;
  }
  if (currentBook) {
    currentBook.destroy();
    currentBook = null;
  }
};

document.getElementById('logoutBtn').onclick = async() => {await supabase.auth.signOut();};
</script>
</body>
</html>
