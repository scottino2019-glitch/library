<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carina â€“ Libreria PDF/EPUB</title>
  <style>
    :root { --primary-color:#6d4c41; --primary-dark:#40241a; --shadow:0 4px 6px rgba(0,0,0,0.1); }
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif;}
    body{background:#f9f9f9;color:#333;}
    header{background:var(--primary-color);color:#fff;padding:1rem;text-align:center;font-weight:bold;}
    main{max-width:1200px;margin:auto;padding:1rem;}
    .hidden{display:none;}
    .btn{background:var(--primary-color);color:#fff;padding:.4rem .8rem;border:none;border-radius:6px;cursor:pointer;margin:.2rem;}
    .btn:hover{background:var(--primary-dark);}
    input{padding:.6rem;border:1px solid #ccc;border-radius:4px;width:100%;}
    form{display:flex;flex-direction:column;gap:.75rem;background:#fff;padding:1rem;border-radius:8px;box-shadow:var(--shadow);max-width:400px;margin:auto;}
    .books-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;margin-top:1rem;}
    .book-card{background:#fff;border-radius:8px;box-shadow:var(--shadow);padding:.5rem;display:flex;flex-direction:column;justify-content:space-between;}
    .book-title{font-weight:bold;margin-bottom:.5rem;}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);justify-content:center;align-items:center;z-index:1000;}
    .reader{display:none;position:fixed;inset:0;background:#fff;z-index:1001;flex-direction:column;}
    .reader-header{background:var(--primary-color);color:#fff;padding:.8rem;display:flex;justify-content:space-between;}
    .reader-content{flex:1;overflow:auto;padding:1rem;}
    #pdfViewer canvas{display:block;margin:auto;box-shadow:var(--shadow);}
    .epub-container{width:100%;height:100%;}
  </style>
</head>
<body>
<header>ðŸ“š My Libraryâ€“ Libreria personale</header>
<main id="authView">
  <h2>Accedi o Registrati</h2>
  <form id="authForm">
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit" class="btn">Login / Registrazione</button>
  </form>
</main>
<main id="appView" class="hidden">
  <div style="display:flex;justify-content:space-between;align-items:center;margin:1rem 0;">
    <h2>La tua libreria</h2>
    <div>
      <button id="uploadBtn" class="btn">Carica libro</button>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>
  </div>
  <div id="booksGrid" class="books-grid"></div>
</main>
<div id="uploadModal" class="modal">
  <form id="uploadForm">
    <input type="text" id="bookTitle" placeholder="Titolo" required>
    <input type="text" id="bookAuthor" placeholder="Autore" required>
    <input type="file" id="bookFile" accept=".pdf,.epub" required>
    <button type="submit" class="btn">Carica</button>
  </form>
</div>
<div class="reader" id="reader">
  <div class="reader-header">
    <div id="readerTitle">Titolo</div>
    <button class="btn" id="closeReader">Chiudi</button>
  </div>
  <div class="reader-content">
    <div id="pdfViewer" hidden></div>
    <div class="epub-container" id="epubViewer" hidden></div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs@0.3/dist/epub.min.js"></script>
<script>
const SUPABASE_URL="https://https://zflxzjapcclnscbziwlt.supabase.co";
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmbHh6amFwY2NsbnNjYnppd2x0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5ODIwMzEsImV4cCI6MjA3MTU1ODAzMX0.8W3FI_fsZtA0EH0TnHJwRbLbvaU476mLAW0DVw7mItI";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const BUCKET="library";
const authView=document.getElementById('authView');
const appView=document.getElementById('appView');
const booksGrid=document.getElementById('booksGrid');
async function checkSession(){const {data}=await supabase.auth.getSession();if(data.session){showApp();loadBooks();}else{showAuth();}}
function showAuth(){authView.classList.remove('hidden');appView.classList.add('hidden');}
function showApp(){authView.classList.add('hidden');appView.classList.remove('hidden');}
document.getElementById('authForm').addEventListener('submit',async e=>{
e.preventDefault();const email=document.getElementById('email').value;const password=document.getElementById('password').value;
let {error}=await supabase.auth.signInWithPassword({email,password});
if(error){const {error:signUpError}=await supabase.auth.signUp({email,password,options:{emailRedirectTo:window.location.origin}});
if(signUpError){alert(signUpError.message);return;}alert("Registrazione effettuata. Controlla la tua email per confermare.");return;}
checkSession();});
window.addEventListener('DOMContentLoaded',async()=>{
const params=new URLSearchParams(window.location.hash.substring(1));
if(params.get('access_token')){
await supabase.auth.setSession({access_token:params.get('access_token'),refresh_token:params.get('refresh_token')});
checkSession();}});
async function loadBooks(){
const {data:{user}}=await supabase.auth.getUser();
const {data,error}=await supabase.from('books').select('*').eq('user_id',user.id).order('created_at',{ascending:false});
if(error){alert(error.message);return;}
booksGrid.innerHTML='';
data.forEach(b=>{
  const card=document.createElement('div');
  card.className='book-card';
  card.innerHTML=`<div class="book-title">${b.title}</div><div>${b.author}</div>`;
  const openBtn=document.createElement('button');openBtn.className='btn';openBtn.textContent='Apri';openBtn.onclick=()=>openBook(b);
  const delBtn=document.createElement('button');delBtn.className='btn';delBtn.textContent='Elimina';delBtn.onclick=()=>deleteBook(b);
  card.appendChild(openBtn);
  card.appendChild(delBtn);
  booksGrid.appendChild(card);
});}
async function deleteBook(book){
if(!confirm(`Eliminare il libro "${book.title}"?`)) return;
const {error:delStorageErr}=await supabase.storage.from(BUCKET).remove([book.storage_path]);
if(delStorageErr){alert("Errore file: "+delStorageErr.message);return;}
const {error:delDbErr}=await supabase.from('books').delete().eq('id',book.id);
if(delDbErr){alert("Errore database: "+delDbErr.message);return;}
loadBooks();}
document.getElementById('uploadBtn').onclick=()=>{document.getElementById('uploadModal').style.display='flex';};
document.getElementById('uploadForm').addEventListener('submit',async e=>{
e.preventDefault();const title=document.getElementById('bookTitle').value;const author=document.getElementById('bookAuthor').value;const file=document.getElementById('bookFile').files[0];if(!file)return;const format=file.name.split('.').pop().toLowerCase();if(!['pdf','epub'].includes(format)){alert('Formato non valido');return;}
const {data:{user}}=await supabase.auth.getUser();
const path=`${user.id}/${Date.now()}_${file.name}`;
const {error:upErr}=await supabase.storage.from(BUCKET).upload(path,file);
if(upErr){alert(upErr.message);return;}
const {error:dbErr}=await supabase.from('books').insert([{title,author,format,storage_path:path,user_id:user.id}]);
if(dbErr){alert(dbErr.message);return;}
document.getElementById('uploadModal').style.display='none';loadBooks();});
async function openBook(book){
document.getElementById('readerTitle').textContent=book.title;
const {data:signedData,error:signedErr}=await supabase.storage.from(BUCKET).createSignedUrl(book.storage_path,3600,{download:false});
if(signedErr||!signedData?.signedUrl){alert("Impossibile generare link libro");return;}
const url=signedData.signedUrl;document.getElementById('reader').style.display='flex';
if(book.format==='pdf'){
document.getElementById('pdfViewer').hidden=false;
document.getElementById('epubViewer').hidden=true;
document.getElementById('pdfViewer').innerHTML='';
pdfjsLib.getDocument(url).promise.then(pdf=>{pdf.getPage(1).then(page=>{
const canvas=document.createElement('canvas');document.getElementById('pdfViewer').appendChild(canvas);
const ctx=canvas.getContext('2d');const viewport=page.getViewport({scale:1.5});
canvas.height=viewport.height;canvas.width=viewport.width;
page.render({canvasContext:ctx,viewport:viewport});
});}).catch(()=>alert("Impossibile aprire il PDF."));
}else{
document.getElementById('pdfViewer').hidden=true;
document.getElementById('epubViewer').hidden=false;
document.getElementById('epubViewer').innerHTML='';
const rendition=ePub(url).renderTo('epubViewer',{width:'100%',height:'100%'});
rendition.display();}}
document.getElementById('closeReader').onclick=()=>{document.getElementById('reader').style.display='none';document.getElementById('pdfViewer').innerHTML='';document.getElementById('epubViewer').innerHTML='';};
document.getElementById('logoutBtn').onclick=async()=>{await supabase.auth.signOut();showAuth();};
checkSession();
</script>
</body>
</html>
