<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carina ‚Äì Libreria Digitale</title>
  <style>
    :root { 
      --primary:#6d4c41; 
      --primary-dark:#40241a; 
      --accent:#ff5722;
      --shadow:0 4px 8px rgba(0,0,0,.15); 
      --radius:8px;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    body{background:#f5f5f5;color:#333;line-height:1.6}
    header{background:var(--primary);color:#fff;padding:1.2rem;text-align:center;font-weight:bold;font-size:1.4rem;box-shadow:var(--shadow)}
    main{max-width:1200px;margin:2rem auto;padding:1rem}
    .hidden{display:none}
    .btn{background:var(--primary);color:#fff;padding:.6rem 1.2rem;border:none;border-radius:var(--radius);cursor:pointer;margin:.3rem;box-shadow:var(--shadow);transition:all 0.3s ease;font-weight:500}
    .btn:hover{background:var(--primary-dark);transform:translateY(-2px)}
    .btn-danger{background:#c62828}
    .btn-danger:hover{background:#b71c1c}
    .btn-accent{background:var(--accent)}
    .btn-accent:hover{background:#e64a19}
    input{padding:.8rem;border:1px solid #ddd;border-radius:var(--radius);width:100%;font-size:1rem}
    input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(109, 76, 65, 0.2)}
    form{display:flex;flex-direction:column;gap:1rem;background:#fff;padding:1.8rem;border-radius:var(--radius);box-shadow:var(--shadow);max-width:450px;margin:2rem auto}
    .form-title{text-align:center;color:var(--primary);margin-bottom:0.5rem}
    .books-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem;margin-top:2rem}
    .book-card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem;display:flex;flex-direction:column;gap:.8rem;position:relative;transition:transform 0.3s ease}
    .book-card:hover{transform:translateY(-5px);box-shadow:0 6px 12px rgba(0,0,0,0.15)}
    .cover{width:100%;aspect-ratio:3/4;background:#eee;border-radius:var(--radius);overflow:hidden;display:flex;align-items:center;justify-content:center}
    .cover img{width:100%;height:100%;object-fit:cover;transition:transform 0.3s ease}
    .book-card:hover .cover img{transform:scale(1.05)}
    .badge{position:absolute;top:1rem;left:1rem;background:rgba(0,0,0,.7);color:#fff;padding:.3rem .6rem;border-radius:4px;font-size:.75rem;font-weight:bold;z-index:10}
    .title{font-weight:bold;font-size:1.1rem;height:2.8rem;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .author{font-size:.95rem;opacity:.9;color:#555}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:auto}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000;padding:1rem}
    .modal form{max-width:500px;width:100%}
    .reader{display:none;position:fixed;inset:0;background:#fff;z-index:1001;flex-direction:column}
    .reader-header{background:var(--primary);color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow)}
    .reader-content{flex:1;overflow:auto;padding:1rem;position:relative}
    .reader-controls{display:flex;justify-content:center;align-items:center;gap:1rem;padding:1rem;background:#f5f5f5;border-bottom:1px solid #ddd;flex-wrap:wrap}
    #pdfViewer{width:100%;overflow:auto;display:flex;flex-direction:column;align-items:center;padding:1rem}
    #pdfViewer canvas{display:block;margin:1rem auto;box-shadow:var(--shadow);max-width:100%}
    #epub-container{width:100%;height:100%;overflow:auto;background:#f9f9f9;padding:2rem;box-sizing:border-box}
    #epub-viewer{max-width:800px;margin:0 auto;background:white;padding:3rem;box-shadow:var(--shadow);min-height:100%;line-height:1.8;font-size:1.1rem}
    #epub-viewer p{margin-bottom:1.5rem}
    .page-navigation{display:flex;align-items:center;gap:0.8rem}
    .epub-controls{display:flex;justify-content:center;gap:1rem;margin:1.5rem 0}
    .loading{display:flex;justify-content:center;align-items:center;height:200px}
    .spinner{border:4px solid rgba(0,0,0,0.1);border-radius:50%;border-top:4px solid var(--primary);width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .empty-state{text-align:center;padding:3rem;color:#777}
    .empty-state i{font-size:3rem;margin-bottom:1rem;color:#ccc}
    .notification{position:fixed;top:20px;right:20px;padding:1rem;background:var(--primary);color:white;border-radius:var(--radius);box-shadow:var(--shadow);z-index:2000;transform:translateX(120%);transition:transform 0.3s ease}
    .notification.show{transform:translateX(0)}
    @media (max-width:768px){
      .books-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:1rem}
      #epub-viewer{padding:1.5rem}
      .reader-controls{flex-direction:column;gap:0.5rem}
    }
  </style>
</head>
<body>
<header>üìö Carina ‚Äì La tua libreria personale</header>

<main id="authView">
  <h2 class="form-title">Accedi o Registrati</h2>
  <form id="authForm">
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit" class="btn">Accedi / Registrati</button>
    <div id="authMsg" style="color:#b3261e;text-align:center"></div>
  </form>
</main>

<main id="appView" class="hidden">
  <div style="display:flex;justify-content:space-between;align-items:center;margin:2rem 0;flex-wrap:wrap;gap:1rem">
    <h2 style="color:var(--primary)">La tua libreria</h2>
    <div>
      <button id="uploadBtn" class="btn btn-accent">‚ûï Carica libro</button>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>
  </div>
  
  <div id="booksGrid" class="books-grid">
    <div class="loading">
      <div class="spinner"></div>
    </div>
  </div>
</main>

<div id="uploadModal" class="modal">
  <form id="uploadForm">
    <h3 class="form-title">Carica un nuovo libro</h3>
    <input type="text" id="bookTitle" placeholder="Titolo" required>
    <input type="text" id="bookAuthor" placeholder="Autore" required>
    <input type="file" id="bookFile" accept=".pdf,.epub" required>
    <div style="display:flex;justify-content:flex-end;gap:.5rem">
      <button type="button" id="cancelUpload" class="btn btn-danger">Annulla</button>
      <button type="submit" class="btn">Carica</button>
    </div>
  </form>
</div>

<div class="reader" id="reader">
  <div class="reader-header">
    <div id="readerTitle">Titolo del libro</div>
    <button class="btn" id="closeReader">‚úï Chiudi</button>
  </div>
  
  <div class="reader-controls" id="pdfControls" hidden>
    <button class="btn" id="prevPage">‚Üê Precedente</button>
    <div class="page-navigation">
      <span>Pagina: </span>
      <span id="pageNum">0</span>
      <span> di </span>
      <span id="pageCount">0</span>
    </div>
    <button class="btn" id="nextPage">Successiva ‚Üí</button>
  </div>
  
  <div class="reader-content">
    <div id="pdfViewer" hidden></div>
    <div id="epub-container" hidden>
      <div id="viewer" class="spreads"></div>
      <div class="epub-controls">
        <button class="btn" id="prevChapter">‚Üê Capitolo Precedente</button>
        <button class="btn" id="nextChapter">Capitolo Successivo ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<div id="notification" class="notification"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>
<!-- Versione corretta di EPUB.js -->
<script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.99/dist/epub.min.js"></script>

<script>
// Configurazione PDF.js
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

const SUPABASE_URL = "https://zflxzjapcclnscbziwlt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmbHh6amFwY2NsbnNjYnppd2x0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5ODIwMzEsImV4cCI6MjA3MTU1ODAzMX0.8W3FI_fsZtA0EH0TnHJwRbLbvaU476mLAW0DVw7mItI";
const BUCKET = "library";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Elementi DOM
const authView = document.getElementById('authView');
const appView = document.getElementById('appView');
const booksGrid = document.getElementById('booksGrid');
const authMsg = document.getElementById('authMsg');
const notification = document.getElementById('notification');

// Variabili per la gestione della visualizzazione
let currentPdf = null;
let currentPage = 1;
let pdfRendering = false;
let pdfPageNumPending = null;
let pdfTotalPages = 0;
let currentBook = null;
let rendition = null;

// Funzioni di utilit√†
function showNotification(message, isError = false) {
  notification.textContent = message;
  notification.style.background = isError ? '#c62828' : 'var(--primary)';
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

function showAuth() {
  authView.classList.remove('hidden');
  appView.classList.add('hidden');
}

function showApp() {
  authView.classList.add('hidden');
  appView.classList.remove('hidden');
}

// Gestione autenticazione
supabase.auth.onAuthStateChange((event) => {
  if (event === 'SIGNED_IN') {
    showApp();
    loadBooks();
  }
  if (event === 'SIGNED_OUT') {
    showAuth();
  }
});

window.addEventListener('DOMContentLoaded', async () => {
  const { data } = await supabase.auth.getSession();
  if (data.session) {
    showApp();
    loadBooks();
  } else {
    showAuth();
  }
});

document.getElementById('authForm').addEventListener('submit', async e => {
  e.preventDefault();
  authMsg.textContent = '';
  
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  
  // Tentativo di login
  let { error } = await supabase.auth.signInWithPassword({ email, password });
  
  if (error) {
    // Se il login fallisce, prova la registrazione
    const { error: err } = await supabase.auth.signUp({
      email,
      password,
      options: { emailRedirectTo: location.origin }
    });
    
    if (err) {
      authMsg.textContent = err.message;
      return;
    }
    
    authMsg.textContent = 'Registrazione riuscita. Controlla la tua email per confermare.';
    showNotification('Registrazione completata! Controlla la tua email.');
  } else {
    showNotification('Accesso effettuato con successo!');
  }
});

// Caricamento libri
async function loadBooks() {
  booksGrid.innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
    </div>
  `;
  
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;
  
  const { data, error } = await supabase
    .from('books')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false });
  
  if (error) {
    booksGrid.innerHTML = `
      <div class="empty-state">
        <div>Errore nel caricamento della libreria</div>
        <div>${error.message}</div>
      </div>
    `;
    return;
  }
  
  if (data.length === 0) {
    booksGrid.innerHTML = `
      <div class="empty-state">
        <div>üìö</div>
        <h3>La tua libreria √® vuota</h3>
        <p>Carica il tuo primo libro cliccando sul pulsante in alto</p>
      </div>
    `;
    return;
  }
  
  booksGrid.innerHTML = '';
  data.forEach(renderBookCard);
}

function renderBookCard(book) {
  const card = document.createElement('div');
  card.className = 'book-card';
  
  const coverWrap = document.createElement('div');
  coverWrap.className = 'cover';
  
  const img = document.createElement('img');
  img.alt = book.title;
  coverWrap.appendChild(img);
  
  const badge = document.createElement('div');
  badge.className = 'badge';
  badge.textContent = book.format.toUpperCase();
  
  const title = document.createElement('div');
  title.className = 'title';
  title.textContent = book.title;
  
  const author = document.createElement('div');
  author.className = 'author';
  author.textContent = book.author;
  
  const actions = document.createElement('div');
  actions.className = 'actions';
  
  const openBtn = document.createElement('button');
  openBtn.className = 'btn';
  openBtn.textContent = 'Apri';
  openBtn.onclick = () => openBook(book);
  
  const delBtn = document.createElement('button');
  delBtn.className = 'btn btn-danger';
  delBtn.textContent = 'Elimina';
  delBtn.onclick = () => deleteBook(book);
  
  actions.appendChild(openBtn);
  actions.appendChild(delBtn);
  
  card.appendChild(coverWrap);
  card.appendChild(badge);
  card.appendChild(title);
  card.appendChild(author);
  card.appendChild(actions);
  
  booksGrid.appendChild(card);
  
  // Genera la copertina
  generateCover(book)
    .then(url => {
      if (url) img.src = url;
    })
    .catch(() => {
      img.src = placeholderCover(book.format);
    });
}

async function generateCover(book) {
  const { data } = await supabase.storage
    .from(BUCKET)
    .createSignedUrl(book.storage_path, 3600, { download: false });
  
  if (!data?.signedUrl) return placeholderCover(book.format);
  
  const url = data.signedUrl;
  
  if (book.format === 'pdf') {
    try {
      const pdf = await pdfjsLib.getDocument(url).promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale: 0.3 });
      
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      
      await page.render({
        canvasContext: canvas.getContext('2d'),
        viewport: viewport
      }).promise;
      
      return canvas.toDataURL('image/png');
    } catch (error) {
      console.error("Errore generazione copertina PDF:", error);
      return placeholderCover(book.format);
    }
  }
  
  return placeholderCover(book.format);
}

function placeholderCover(format) {
  const canvas = document.createElement('canvas');
  canvas.width = 300;
  canvas.height = 400;
  const ctx = canvas.getContext('2d');
  
  // Sfondo
  ctx.fillStyle = '#6d4c41';
  ctx.fillRect(0, 0, 300, 400);
  
  // Dettaglio
  ctx.fillStyle = '#8d6e63';
  ctx.fillRect(20, 20, 260, 360);
  
  // Testo
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 24px sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(format.toUpperCase(), 150, 200);
  
  return canvas.toDataURL('image/png');
}

// Gestione modale di caricamento
document.getElementById('uploadBtn').onclick = () => {
  document.getElementById('uploadModal').style.display = 'flex';
};

document.getElementById('cancelUpload').onclick = () => {
  document.getElementById('uploadModal').style.display = 'none';
  document.getElementById('uploadForm').reset();
};

document.getElementById('uploadForm').addEventListener('submit', async e => {
  e.preventDefault();
  
  const title = document.getElementById('bookTitle').value.trim();
  const author = document.getElementById('bookAuthor').value.trim();
  const file = document.getElementById('bookFile').files[0];
  
  if (!file) {
    showNotification('Seleziona un file da caricare', true);
    return;
  }
  
  const format = file.name.split('.').pop().toLowerCase();
  if (!['pdf', 'epub'].includes(format)) {
    showNotification('Formato file non supportato. Usa PDF o EPUB.', true);
    return;
  }
  
  const { data: { user } } = await supabase.auth.getUser();
  const path = `${user.id}/${Date.now()}_${file.name.replace(/\s/g, '_')}`;
  
  try {
    // Upload del file
    const { error: uploadError } = await supabase.storage
      .from(BUCKET)
      .upload(path, file);
    
    if (uploadError) throw uploadError;
    
    // Inserimento nel database
    const { error: dbError } = await supabase
      .from('books')
      .insert([{ title, author, format, storage_path: path, user_id: user.id }]);
    
    if (dbError) throw dbError;
    
    showNotification('Libro caricato con successo!');
    document.getElementById('uploadModal').style.display = 'none';
    document.getElementById('uploadForm').reset();
    loadBooks();
  } catch (error) {
    console.error('Errore durante il caricamento:', error);
    showNotification('Errore durante il caricamento: ' + error.message, true);
  }
});

async function deleteBook(book) {
  if (!confirm(`Sei sicuro di voler eliminare "${book.title}"?`)) return;
  
  try {
    // Elimina file dallo storage
    const { error: storageError } = await supabase.storage
      .from(BUCKET)
      .remove([book.storage_path]);
    
    if (storageError) throw storageError;
    
    // Elimina record dal database
    const { error: dbError } = await supabase
      .from('books')
      .delete()
      .eq('id', book.id);
    
    if (dbError) throw dbError;
    
    showNotification('Libro eliminato con successo');
    loadBooks();
  } catch (error) {
    console.error('Errore durante l\'eliminazione:', error);
    showNotification('Errore durante l\'eliminazione: ' + error.message, true);
  }
}

// Funzioni per la navigazione del PDF
function renderPage(pageNum) {
  pdfRendering = true;
  
  currentPdf.getPage(pageNum).then(function(page) {
    const viewport = page.getViewport({ scale: 1.5 });
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    const renderContext = {
      canvasContext: ctx,
      viewport: viewport
    };
    
    const renderTask = page.render(renderContext);
    
    renderTask.promise.then(function() {
      pdfRendering = false;
      
      const pdfViewer = document.getElementById('pdfViewer');
      pdfViewer.innerHTML = '';
      pdfViewer.appendChild(canvas);
      
      document.getElementById('pageNum').textContent = pageNum;
      
      if (pdfPageNumPending !== null) {
        renderPage(pdfPageNumPending);
        pdfPageNumPending = null;
      }
    });
  }).catch(error => {
    console.error('Errore nel rendering della pagina:', error);
    pdfRendering = false;
  });
}

function queueRenderPage(num) {
  if (pdfRendering) {
    pdfPageNumPending = num;
  } else {
    renderPage(num);
  }
}

function onPrevPage() {
  if (currentPage <= 1) return;
  currentPage--;
  queueRenderPage(currentPage);
}

function onNextPage() {
  if (currentPage >= pdfTotalPages) return;
  currentPage++;
  queueRenderPage(currentPage);
}

// Funzioni per la navigazione dell'EPUB
function prevChapter() {
  if (rendition) rendition.prev();
}

function nextChapter() {
  if (rendition) rendition.next();
}

// Aggiungi event listeners per la navigazione
document.getElementById('prevPage').addEventListener('click', onPrevPage);
document.getElementById('nextPage').addEventListener('click', onNextPage);
document.getElementById('prevChapter').addEventListener('click', prevChapter);
document.getElementById('nextChapter').addEventListener('click', nextChapter);

// Apertura libro
async function openBook(book) {
  document.getElementById('readerTitle').textContent = book.title;
  
  try {
    const { data } = await supabase.storage
      .from(BUCKET)
      .createSignedUrl(book.storage_path, 3600, { download: false });
    
    if (!data?.signedUrl) throw new Error('Impossibile ottenere il file');
    
    const url = data.signedUrl;
    document.getElementById('reader').style.display = 'flex';
    
    if (book.format === 'pdf') {
      // Visualizzazione PDF
      document.getElementById('pdfViewer').hidden = false;
      document.getElementById('epub-container').hidden = true;
      document.getElementById('pdfControls').hidden = false;
      
      currentPdf = await pdfjsLib.getDocument(url).promise;
      pdfTotalPages = currentPdf.numPages;
      document.getElementById('pageCount').textContent = pdfTotalPages;
      currentPage = 1;
      renderPage(currentPage);
    } else {
      // Visualizzazione EPUB
      document.getElementById('pdfViewer').hidden = true;
      document.getElementById('epub-container').hidden = false;
      document.getElementById('pdfControls').hidden = true;
      
      // Pulisci eventuali libri precedenti
      if (currentBook) {
        currentBook.destroy();
        currentBook = null;
      }
      
      if (rendition) {
        rendition.destroy();
        rendition = null;
      }
      
      // Crea un nuovo libro EPUB
      currentBook = ePub(url);
      
      // Crea il rendering
      rendition = currentBook.renderTo("viewer", {
        width: "100%",
        height: 600,
        spread: "auto"
      });
      
      // Visualizza il libro
      rendition.display();
      
      // Aggiungi stili per una migliore visualizzazione
      rendition.hooks.content.register(function(contents) {
        contents.addStylesheet(`
          body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.8;
            color: #333;
            padding: 2rem;
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
          }
          p {
            margin-bottom: 1.5rem;
          }
          h1, h2, h3, h4, h5, h6 {
            color: #6d4c41;
            margin-top: 2rem;
            margin-bottom: 1rem;
          }
        `);
      });
      
      // Gestione errori
      rendition.on("rendered", function(section) {
        console.log("EPUB rendered successfully", section);
      });
      
      rendition.on("error", function(err) {
        console.error("EPUB rendering error:", err);
        document.getElementById('viewer').innerHTML = `
          <div class="empty-state">
            <h3>Errore nel caricamento del libro</h3>
            <p>${err.message}</p>
          </div>
        `;
      });
    }
  } catch (error) {
    console.error('Errore apertura libro:', error);
    showNotification('Errore: Impossibile aprire il libro', true);
  }
}

// Chiusura reader
document.getElementById('closeReader').onclick = () => {
  document.getElementById('reader').style.display = 'none';
  document.getElementById('pdfViewer').innerHTML = '';
  
  // Reset variabili PDF
  currentPdf = null;
  currentPage = 1;
  pdfRendering = false;
  pdfPageNumPending = null;
  pdfTotalPages = 0;
  
  // Reset variabili EPUB
  if (rendition) {
    rendition.destroy();
    rendition = null;
  }
  if (currentBook) {
    currentBook.destroy();
    currentBook = null;
  }
  
  document.getElementById('viewer').innerHTML = '';
};

// Logout
document.getElementById('logoutBtn').onclick = async () => {
  await supabase.auth.signOut();
  showNotification('Logout effettuato');
};
</script>
</body>
</html>
