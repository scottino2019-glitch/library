<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carina â€“ Libreria PDF/EPUB (login fix + copertine + scaffali)</title>
  <style>
    :root { --primary:#6d4c41; --primary-dark:#40241a; --shadow:0 4px 10px rgba(0,0,0,.1); }
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    body{background:#faf9f8;color:#333}
    header{background:var(--primary);color:#fff;padding:1rem;text-align:center;font-weight:700}
    main{max-width:1200px;margin:auto;padding:1rem}
    .hidden{display:none}
    .btn{background:var(--primary);color:#fff;padding:.45rem .9rem;border:none;border-radius:8px;cursor:pointer;margin:.2rem;box-shadow:var(--shadow)}
    .btn:hover{background:var(--primary-dark)}
    .btn-danger{background:#b3261e}
    input{padding:.65rem;border:1px solid #d0d0d0;border-radius:8px;width:100%}
    form{display:flex;flex-direction:column;gap:.75rem;background:#fff;padding:1rem;border-radius:12px;box-shadow:var(--shadow);max-width:420px;margin:auto}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin:1rem 0}
    .books-grid{position:relative;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1rem;margin-top:1rem}
    /* Effetto scaffali: righe leggermente ombreggiate */
    .books-grid:before{content:"";position:absolute;inset:0;pointer-events:none;background:repeating-linear-gradient( to bottom, rgba(0,0,0,0) 0, rgba(0,0,0,0) calc(100%/3 - 6px), rgba(0,0,0,0.05) calc(100%/3 - 6px), rgba(0,0,0,0.05) calc(100%/3 - 4px) )}
    .book-card{background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:.6rem;display:flex;flex-direction:column;gap:.5rem;position:relative}
    .cover{width:100%;aspect-ratio:3/4;border-radius:8px;overflow:hidden;background:#eee;display:flex;align-items:center;justify-content:center}
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;top:.6rem;left:.6rem;background:rgba(0,0,0,.6);color:#fff;padding:.15rem .4rem;border-radius:6px;font-size:.75rem}
    .title{font-weight:700}
    .author{opacity:.8;font-size:.95rem}
    .actions{margin-top:.3rem;display:flex;gap:.35rem;flex-wrap:wrap}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);justify-content:center;align-items:center;z-index:1000}
    .reader{display:none;position:fixed;inset:0;background:#fff;z-index:1001;flex-direction:column}
    .reader-header{background:var(--primary);color:#fff;padding:.8rem;display:flex;justify-content:space-between;align-items:center}
    .reader-content{flex:1;overflow:auto;padding:1rem}
    #pdfViewer canvas{display:block;margin:1rem auto;box-shadow:var(--shadow)}
    .epub-container{width:100%;height:100%}
    .note{margin:.5rem auto;max-width:420px;color:#555;font-size:.95rem}
    .warn{color:#b3261e}
  </style>
</head>
<body>
<header>ðŸ“š Carina â€“ Libreria personale</header>

<!-- LOGIN -->
<main id="authView">
  <h2 style="text-align:center;margin-bottom:.6rem">Accedi o Registrati</h2>
  <form id="authForm">
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit" class="btn">Login / Registrazione</button>
    <div id="authMsg" class="note"></div>
  </form>
  <div id="localWarn" class="note warn hidden">Stai aprendo il file da <b>file://</b>. Per il login Supabase usa un server locale (es. <code>npm serve</code>) o pubblica su Vercel/Netlify.</div>
</main>

<!-- APP -->
<main id="appView" class="hidden">
  <div class="topbar">
    <h2>La tua libreria</h2>
    <div>
      <button id="uploadBtn" class="btn">Carica libro</button>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>
  </div>
  <div id="booksGrid" class="books-grid"></div>
</main>

<!-- MODAL UPLOAD -->
<div id="uploadModal" class="modal">
  <form id="uploadForm">
    <h3>Nuovo libro</h3>
    <input type="text" id="bookTitle" placeholder="Titolo" required>
    <input type="text" id="bookAuthor" placeholder="Autore" required>
    <input type="file" id="bookFile" accept=".pdf,.epub" required>
    <div style="display:flex;justify-content:flex-end;gap:.5rem">
      <button type="button" id="cancelUpload" class="btn">Annulla</button>
      <button type="submit" class="btn">Carica</button>
    </div>
  </form>
</div>

<!-- READER -->
<div class="reader" id="reader">
  <div class="reader-header">
    <div id="readerTitle">Titolo</div>
    <button class="btn" id="closeReader">Chiudi</button>
  </div>
  <div class="reader-content">
    <div id="pdfViewer" hidden></div>
    <div class="epub-container" id="epubViewer" hidden></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs@0.3/dist/epub.min.js"></script>
<script>
  // === CONFIG ===
  const SUPABASE_URL = "https://TUO-PROGETTO.supabase.co";
  const SUPABASE_KEY = "CHIAVE-ANON";
  const BUCKET = "library"; // controlla che corrisponda esattamente

  // === INIT ===
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const authView = document.getElementById('authView');
  const appView = document.getElementById('appView');
  const booksGrid = document.getElementById('booksGrid');
  const authMsg = document.getElementById('authMsg');
  const localWarn = document.getElementById('localWarn');

  // pdf.js worker
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js';
  }

  // Helper UI
  function showAuth(){ authView.classList.remove('hidden'); appView.classList.add('hidden'); }
  function showApp(){ authView.classList.add('hidden'); appView.classList.remove('hidden'); }

  // Friendly warning if opened as file://
  if (location.protocol === 'file:') {
    localWarn.classList.remove('hidden');
  }

  // Auth state listener (piÃ¹ robusto del solo checkSession)
  supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN') { showApp(); loadBooks(); }
    if (event === 'SIGNED_OUT') { showAuth(); }
  });

  // Gestione conferma via email dopo redirect
  window.addEventListener('DOMContentLoaded', async () => {
    const hash = new URLSearchParams(location.hash.slice(1));
    const at = hash.get('access_token');
    const rt = hash.get('refresh_token');
    if (at && rt) {
      await supabase.auth.setSession({ access_token: at, refresh_token: rt });
    } else {
      // nessun token nell'URL: controlla sessione esistente (cookie/localStorage)
      const { data } = await supabase.auth.getSession();
      if (data.session) { showApp(); loadBooks(); } else { showAuth(); }
    }
  });

  // Login + Registrazione con messaggi espliciti
  document.getElementById('authForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    authMsg.textContent = '';
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    // Tenta login
    let { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      // Se fallisce, prova registrazione (con redirect alla stessa pagina)
      const { error: signUpError } = await supabase.auth.signUp({
        email,
        password,
        options: { emailRedirectTo: location.origin }
      });
      if (signUpError) {
        authMsg.textContent = signUpError.message.includes('Invalid login credentials') ?
          'Credenziali non valide oppure email non confermata.' : signUpError.message;
        return;
      }
      authMsg.textContent = 'Registrazione effettuata. Controlla la tua email e conferma l\'account per accedere.';
      return;
    }
    // Se il login va a buon fine, l'onAuthStateChange chiamerÃ  loadBooks()
  });

  // Caricamento libri dell'utente corrente
  async function loadBooks(){
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;
    const { data, error } = await supabase
      .from('books')
      .select('*')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });
    if (error) { alert(error.message); return; }

    booksGrid.innerHTML = '';
    data.forEach(renderBookCard);
  }

  // Render di una card con copertina + azioni
  function renderBookCard(b) {
    const card = document.createElement('div');
    card.className = 'book-card';

    const coverWrap = document.createElement('div');
    coverWrap.className = 'cover';
    const badge = document.createElement('div');
    badge.className = 'badge';
    badge.textContent = b.format.toUpperCase();
    const img = document.createElement('img');
    img.alt = `Copertina ${b.title}`;
    coverWrap.appendChild(img);
    card.appendChild(coverWrap);
    card.appendChild(badge);

    const t = document.createElement('div'); t.className = 'title'; t.textContent = b.title; card.appendChild(t);
    const a = document.createElement('div'); a.className = 'author'; a.textContent = b.author; card.appendChild(a);

    const actions = document.createElement('div'); actions.className = 'actions';
    const openBtn = document.createElement('button'); openBtn.className = 'btn'; openBtn.textContent = 'Apri'; openBtn.onclick = () => openBook(b);
    const delBtn = document.createElement('button'); delBtn.className = 'btn btn-danger'; delBtn.textContent = 'Elimina'; delBtn.onclick = () => deleteBook(b);
    actions.appendChild(openBtn); actions.appendChild(delBtn); card.appendChild(actions);

    booksGrid.appendChild(card);

    // genera copertina (async)
    generateCover(b).then(url => { if (url) img.src = url; }).catch(()=>{});
  }

  // Crea URL firmato e genera copertina
  async function generateCover(book){
    try{
      const { data: s, error: e } = await supabase.storage.from(BUCKET).createSignedUrl(book.storage_path, 3600, { download:false });
      if (e || !s?.signedUrl) return placeholderCover(book.format);
      const url = s.signedUrl;
      if (book.format === 'pdf') {
        // miniatura prima pagina PDF
        const pdf = await pdfjsLib.getDocument(url).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 0.3 });
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
        return canvas.toDataURL('image/png');
      } else {
        // EPUB: prova a recuperare la cover via epub.js, altrimenti placeholder
        try {
          const book = ePub(url);
          const coverUrl = await book.coverUrl();
          if (coverUrl) return coverUrl;
        } catch(_) {}
        return placeholderCover('EPUB');
      }
    }catch(_){ return placeholderCover(book.format); }
  }

  // Placeholder cover con canvas
  function placeholderCover(text){
    const c = document.createElement('canvas');
    c.width = 300; c.height = 400; const ctx = c.getContext('2d');
    const g = ctx.createLinearGradient(0,0,0,400); g.addColorStop(0,'#d7ccc8'); g.addColorStop(1,'#a1887f');
    ctx.fillStyle = g; ctx.fillRect(0,0,300,400);
    ctx.fillStyle = 'rgba(255,255,255,.9)'; ctx.fillRect(20,20,260,360);
    ctx.fillStyle = '#333'; ctx.font = 'bold 36px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(text.toUpperCase(), 150, 200);
    return c.toDataURL('image/png');
  }

  // Upload
  document.getElementById('uploadBtn').onclick = () => { document.getElementById('uploadModal').style.display='flex'; };
  document.getElementById('cancelUpload').onclick = () => { document.getElementById('uploadModal').style.display='none'; };
  document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = document.getElementById('bookTitle').value.trim();
    const author = document.getElementById('bookAuthor').value.trim();
    const file = document.getElementById('bookFile').files[0];
    if (!file) return;
    const format = file.name.split('.').pop().toLowerCase();
    if (!['pdf','epub'].includes(format)) { alert('Formato non valido'); return; }

    const { data: { user } } = await supabase.auth.getUser();
    const path = `${user.id}/${Date.now()}_${file.name}`;

    const { error: upErr } = await supabase.storage.from(BUCKET).upload(path, file);
    if (upErr) { alert('Errore upload: ' + upErr.message); return; }

    const { error: dbErr } = await supabase.from('books').insert([{ title, author, format, storage_path: path, user_id: user.id }]);
    if (dbErr) { alert('Errore database: ' + dbErr.message); return; }

    document.getElementById('uploadModal').style.display='none';
    document.getElementById('uploadForm').reset();
    loadBooks();
  });

  // Delete
  async function deleteBook(book){
    if (!confirm(`Eliminare il libro "${book.title}"?`)) return;
    const { error: delStorageErr } = await supabase.storage.from(BUCKET).remove([book.storage_path]);
    if (delStorageErr) { alert('Errore file: ' + delStorageErr.message); return; }
    const { error: delDbErr } = await supabase.from('books').delete().eq('id', book.id);
    if (delDbErr) { alert('Errore database: ' + delDbErr.message); return; }
    loadBooks();
  }

  // Open (viewer inline, con link firmato)
  async function openBook(book){
    document.getElementById('readerTitle').textContent = book.title;
    const { data: s, error: e } = await supabase.storage.from(BUCKET).createSignedUrl(book.storage_path, 3600, { download:false });
    if (e || !s?.signedUrl) { alert('Impossibile generare link libro'); return; }
    const url = s.signedUrl;
    document.getElementById('reader').style.display='flex';

    if (book.format === 'pdf') {
      document.getElementById('pdfViewer').hidden = false;
      document.getElementById('epubViewer').hidden = true;
      document.getElementById('pdfViewer').innerHTML = '';
      try {
        const pdf = await pdfjsLib.getDocument(url).promise;
        // render prime 3 pagine come esempio (puoi aumentare)
        const total = Math.min(3, pdf.numPages);
        for (let p=1; p<=total; p++){
          const page = await pdf.getPage(p);
          const viewport = page.getViewport({ scale: 1.2 });
          const canvas = document.createElement('canvas');
          canvas.width = viewport.width; canvas.height = viewport.height;
          await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
          document.getElementById('pdfViewer').appendChild(canvas);
        }
      } catch { alert('Impossibile aprire il PDF.'); }
    } else {
      document.getElementById('pdfViewer').hidden = true;
      document.getElementById('epubViewer').hidden = false;
      document.getElementById('epubViewer').innerHTML = '';
      const rendition = ePub(url).renderTo('epubViewer', { width:'100%', height:'100%' });
      rendition.display();
    }
  }

  document.getElementById('closeReader').onclick = () => {
    document.getElementById('reader').style.display='none';
    document.getElementById('pdfViewer').innerHTML='';
    document.getElementById('epubViewer').innerHTML='';
  };

  document.getElementById('logoutBtn').onclick = async () => { await supabase.auth.signOut(); };
</script>
</body>
</html>
