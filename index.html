<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library â€“ Libreria personale completa</title>
  <style>
    /* Stili completi */
    :root { --primary-color: #6d4c41; --primary-dark:#40241a; --text-color:#333; --shadow:0 4px 6px rgba(0,0,0,0.1); }
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif;}
    body{background:#f9f9f9;color:var(--text-color);line-height:1.6;}
    header{background:var(--primary-color);color:#fff;padding:1rem;text-align:center;font-weight:bold;}
    main{max-width:1200px;margin:auto;padding:1rem;}
    .hidden{display:none;}
    .btn{background:var(--primary-color);color:#fff;padding:.6rem 1rem;border:none;border-radius:6px;cursor:pointer;}
    .btn:hover{background:var(--primary-dark);}
    input{padding:.6rem;border:1px solid #ccc;border-radius:4px;width:100%;}
    form{display:flex;flex-direction:column;gap:.75rem;background:#fff;padding:1rem;border-radius:8px;box-shadow:var(--shadow);max-width:400px;margin:auto;}
    .library-header{display:flex;justify-content:space-between;align-items:center;margin:1rem 0;}
    .books-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem;}
    .book-card{background:#fff;border-radius:8px;box-shadow:var(--shadow);padding:1rem;cursor:pointer;transition:.2s;}
    .book-card:hover{transform:translateY(-3px);}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.45);justify-content:center;align-items:center;z-index:1000;}
    .modal form{max-width:500px;}
    .reader{display:none;position:fixed;inset:0;background:#fff;z-index:1001;flex-direction:column;}
    .reader-header{background:var(--primary-color);color:#fff;padding:.8rem;display:flex;justify-content:space-between;}
    .reader-content{flex:1;overflow:auto;padding:1rem;}
    .pdf-container,.epub-container{width:100%;height:100%;max-width:900px;margin:auto;}
  </style>
</head>
<body>
  <header>ðŸ“š Carina â€“ Libreria personale</header>

  <!-- LOGIN -->
  <main id="authView">
    <h2>Accedi o Registrati</h2>
    <form id="authForm">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit" class="btn">Login / Registrazione</button>
    </form>
  </main>

  <!-- LIBRERIA -->
  <main id="appView" class="hidden">
    <div class="library-header">
      <h2>La tua libreria</h2>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>
    <div>
      <button id="uploadBtn" class="btn">Carica libro</button>
    </div>
    <div id="booksGrid" class="books-grid"></div>
  </main>

  <!-- Modal caricamento libro -->
  <div id="uploadModal" class="modal">
    <form id="uploadForm">
      <input type="text" id="bookTitle" placeholder="Titolo" required>
      <input type="text" id="bookAuthor" placeholder="Autore" required>
      <input type="file" id="bookFile" accept=".pdf,.epub" required>
      <button type="submit" class="btn">Carica</button>
    </form>
  </div>

  <!-- Reader -->
  <div class="reader" id="reader">
    <div class="reader-header">
      <div id="readerTitle">Titolo</div>
      <button class="btn" id="closeReader">Chiudi</button>
    </div>
    <div class="reader-content">
      <div class="pdf-container" id="pdfViewer" hidden></div>
      <div class="epub-container" id="epubViewer" hidden></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3/dist/epub.min.js"></script>
  <script>
    const SUPABASE_URL = "https://zflxzjapcclnscbziwlt.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmbHh6amFwY2NsbnNjYnppd2x0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5ODIwMzEsImV4cCI6MjA3MTU1ODAzMX0.8W3FI_fsZtA0EH0TnHJwRbLbvaU476mLAW0DVw7mItI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const BUCKET = "library";

    const authView=document.getElementById('authView');
    const appView=document.getElementById('appView');
    const authForm=document.getElementById('authForm');
    const booksGrid=document.getElementById('booksGrid');

    async function checkSession(){
      const { data } = await supabase.auth.getSession();
      if(data.session){ showApp(); loadBooks(); } else { showAuth(); }
    }
    function showAuth(){authView.classList.remove('hidden');appView.classList.add('hidden');}
    function showApp(){authView.classList.add('hidden');appView.classList.remove('hidden');}

    authForm.addEventListener('submit',async(e)=>{
      e.preventDefault();
      const email=document.getElementById('email').value;
      const password=document.getElementById('password').value;
      let { error }=await supabase.auth.signInWithPassword({email,password});
      if(error){
        const { error:signUpError }=await supabase.auth.signUp({email,password});
        if(signUpError){alert(signUpError.message);return;}
      }
      checkSession();
    });

    async function loadBooks(){
      const { data: { user } }=await supabase.auth.getUser();
      const { data,error }=await supabase.from('books').select('*').eq('user_id',user.id).order('created_at',{ascending:false});
      if(error){alert(error.message);return;}
      booksGrid.innerHTML='';
      data.forEach(b=>{
        const card=document.createElement('div');
        card.className='book-card';
        card.textContent=b.title+" â€“ "+b.author;
        card.addEventListener('click',()=>openBook(b));
        booksGrid.appendChild(card);
      });
    }

    document.getElementById('uploadBtn').onclick=()=>{
      document.getElementById('uploadModal').style.display='flex';
    };
    document.getElementById('uploadForm').addEventListener('submit',async(e)=>{
      e.preventDefault();
      const title=document.getElementById('bookTitle').value;
      const author=document.getElementById('bookAuthor').value;
      const file=document.getElementById('bookFile').files[0];
      if(!file)return;
      const format=file.name.split('.').pop().toLowerCase();
      if(!['pdf','epub'].includes(format)){alert('Formato non valido');return;}
      const { data: { user } }=await supabase.auth.getUser();
      // 1) Carica file su Storage
      const path=`${user.id}/${Date.now()}_${file.name}`;
      const { error:uploadErr }=await supabase.storage.from(BUCKET).upload(path,file);
      if(uploadErr){alert(uploadErr.message);return;}
      // 2) Salva metadati
      const { error:dbErr }=await supabase.from('books').insert([{title,author,format,storage_path:path,user_id:user.id}]);
      if(dbErr){alert(dbErr.message);return;}
      document.getElementById('uploadModal').style.display='none';
      loadBooks();
    });

    async function openBook(book){
      document.getElementById('readerTitle').textContent=book.title;
      const { data }=supabase.storage.from(BUCKET).getPublicUrl(book.storage_path);
      const url=data.publicUrl;
      document.getElementById('reader').style.display='flex';
      if(book.format==='pdf'){
        document.getElementById('pdfViewer').innerHTML=`<iframe src="${url}" style="width:100%;height:100%;"></iframe>`;
        document.getElementById('pdfViewer').hidden=false;
        document.getElementById('epubViewer').hidden=true;
      }else{
        document.getElementById('epubViewer').hidden=false;
        document.getElementById('pdfViewer').hidden=true;
        const rendition=ePub(url).renderTo('epubViewer',{width:'100%',height:'100%'});
        rendition.display();
      }
    }

    document.getElementById('closeReader').onclick=()=>{
      document.getElementById('reader').style.display='none';
      document.getElementById('pdfViewer').innerHTML='';
      document.getElementById('epubViewer').innerHTML='';
    };
    document.getElementById('logoutBtn').onclick=async()=>{await supabase.auth.signOut();showAuth();};

    checkSession();
  </script>
</body>
</html>
